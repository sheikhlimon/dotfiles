#!/bin/bash

# sudo pacman -S zsh
# chmod +x ~/post_install
# ~./post_install

# Function to install missing zsh plugins
install_oh_my_zsh() {
  # Define ZSH and ZSH_CUSTOM paths
  ZSH="${ZSH:-$HOME/.oh-my-zsh}"
  ZSH_CUSTOM="${ZSH_CUSTOM:-$ZSH/custom}"

  # Install Oh My Zsh if not already installed
  if [[ ! -d "$ZSH" ]]; then
    echo "Installing Oh My Zsh..."
    RUNZSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
  else
    echo "Oh My Zsh already installed at $ZSH"
  fi

  # Plugins to install
  local plugins=(
    "https://github.com/zsh-users/zsh-autosuggestions"
    "https://github.com/zsh-users/zsh-syntax-highlighting"
  )

  # Create custom plugin directory if missing
  mkdir -p "$ZSH_CUSTOM/plugins"

  # Clone plugins if missing
  for url in "${plugins[@]}"; do
    local name=$(basename "$url")
    local plugin_dir="$ZSH_CUSTOM/plugins/$name"

    if [[ ! -d "$plugin_dir" ]]; then
      echo "Installing plugin: $name"
      git clone "$url" "$plugin_dir"
    else
      echo "Plugin $name already installed"
    fi
  done
}

install_zshrc_support() {
  if [[ -f /etc/arch-release ]]; then
    echo "Detected Arch Linux"
    yay -S --needed multitail eza fd bat yazi fzf zoxide trash-cli tree duf

  elif [[ -f /etc/debian_version ]]; then
    echo "Detected Debian-based system"
    sudo apt update
    sudo apt install -y multitail eza fd bat fzf zoxide trash-cli tree duf

    # Optional: Install `yazi` if it's not in apt (available via cargo or deb)
    if ! command -v yazi &>/dev/null; then
      echo "yazi not found in apt; installing from GitHub..."
      tmp_dir=$(mktemp -d)
      (
        cd "$tmp_dir"
        curl -LO https://github.com/sxyazi/yazi/releases/latest/download/yazi_amd64.deb
        sudo dpkg -i yazi_amd64.deb
      )
      rm -rf "$tmp_dir"
    fi

  else
    echo "Unsupported OS — only Arch and Debian-based systems are supported for now."
  fi
}

install_my_apps() {
  # Use the dedicated app installer script
  if [[ -f "$(dirname "$0")/install_apps.sh" ]]; then
    echo "Running app installer..."
    "$(dirname "$0")/install_apps.sh"
  else
    echo "Error: install_apps.sh not found in scripts directory"
    return 1
  fi
}

install_tmux_plugins() {
  echo "Installing TPM (Tmux Plugin Manager)..."

  local tpm_dir="$HOME/.tmux/plugins/tpm"

  if [[ ! -d "$tpm_dir" ]]; then
    echo "Cloning TPM..."
    git clone https://github.com/tmux-plugins/tpm "$tpm_dir"
    echo "TPM installed successfully."
    echo "Remember to press 'prefix + I' in tmux to install plugins."
  else
    echo "TPM already installed at $tpm_dir"
  fi
}

setup_databases() {
  # Use the dedicated database setup script
  if [[ -f "$(dirname "$0")/setup_databases.sh" ]]; then
    echo "Running database setup..."
    "$(dirname "$0")/setup_databases.sh"
  else
    echo "Error: setup_databases.sh not found in scripts directory"
    return 1
  fi
}

ask_and_run() {
  read -rp "$1 [y/N]: " answer
  if [[ "$answer" =~ ^[Yy]$ ]]; then
    echo "Running $2..."
    $2
  else
    echo "Skipping $2."
  fi
  echo
}

post_install() {
  ask_and_run "Install Oh My Zsh + plugins?" install_oh_my_zsh
  ask_and_run "Install CLI support tools?" install_zshrc_support
  ask_and_run "Install desktop apps?" install_my_apps
  ask_and_run "Install TPM (Tmux Plugin Manager)?" install_tmux_plugins
  ask_and_run "Setup databases (MongoDB + PostgreSQL)?" setup_databases

  echo "✅ All done!"

  echo "Restart your shell or run: source ~/.zshrc"
}

# Call the function
post_install
